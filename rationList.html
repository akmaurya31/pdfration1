<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Ration List</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-50">

<div id="header"></div>

<div class="container my-4 mx-auto">
  <h4 class="text-xl text-center bg-blue-500 text-white py-2 my-4 rounded font-bold mx-auto w-[30%]">🧑All Ration List🛒</h4>

  <div class="max-w-[1350px] mx-auto text-center py-2">
    <input type="text" id="searchInput" placeholder="Search by Mobile, Name or Ration Card" class="border p-2 w-[50%]" />
    <button onclick="loadData(1)" class="bg-blue-500 text-white py-2 px-4 rounded">Search</button>
  </div>

  <div class="max-w-[1350px] mx-auto">
    <table id="requestTable" class="w-full text-sm text-left text-black-500">
      <thead class="bg-gray-100 border-b border-gray-200">
        <tr class="text-left">
          <th class="px-6 py-3 font-bold text-gray-700">Sn</th>
          <th class="px-6 py-3 font-bold text-gray-700">User ID</th>
          <th class="px-6 py-3 font-bold text-gray-700">Candidate Name</th>
          <th class="px-6 py-3 font-bold text-gray-700">Janpad</th>
          <th class="px-6 py-3 font-bold text-gray-700">Ration Card No.</th>
          <th class="px-6 py-3 font-bold text-gray-700">PDF</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="flex justify-between items-center mt-4 mx-auto">
      <span id="pageInfo" class="text-gray-600"></span>
      <div class="flex items-center space-x-2">
        <input type="number" id="pageNumberInput" placeholder="Page #" class="border p-1 w-16 text-center">
        <button onclick="goToPage()" class="bg-green-500 text-white py-1 px-4 rounded">Go</button>
        <button onclick="prevPage()" class="bg-blue-500 text-white py-1 px-4 rounded">Previous</button>
        <button onclick="nextPage()" class="bg-blue-500 text-white py-1 px-4 rounded">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="popup-modal" tabindex="-1" 
     class="hidden fixed inset-0 z-50 justify-center items-center bg-black bg-opacity-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Ration Detail</h2>
      <button onclick="closeModal()" class="text-red-500 font-bold">X</button>
    </div>

    <form action="" method="post" id="rationForm" name="rationForm" enctype="multipart/form-data">
      <div class="flex flex-wrap -mx-2 mb-4">
        <div class="w-full md:w-1/3 px-2 mb-4 md:mb-0">
          <label for="dration_no" class="block text-gray-700 font-bold mb-2">Rashan Card No:</label>
          <input type="text" class="bg-gray-100 border border-gray-300 rounded-lg p-2 w-full" id="dration_no" name="ration_no" placeholder="Enter Your Rashan Card No.">
          <input type="hidden" id="frid" name="rid">
        </div>
        <div class="w-full md:w-1/3 px-2 mb-4 md:mb-0">
          <label for="mukhiya" class="block text-gray-700 font-bold mb-2">Mukhiya Name:</label>
          <input type="text" class="bg-gray-100 border border-gray-300 rounded-lg p-2 w-full" id="mukhiya" name="mukhiya" placeholder="Enter Your Mukhiya Name">
        </div>
        <div class="w-full md:w-1/3 px-2">
          <label for="Janpad" class="block text-gray-700 font-bold mb-2">जनपद:</label>
          <input type="text" class="bg-gray-100 border border-gray-300 rounded-lg p-2 w-full" id="Janpad" name="Janpad" placeholder="Enter Your Janpad Name">
        </div>
      </div>
      <div class="w-full md:w-1/3 px-2 mb-4 md:mb-0">
        <label for="DrivePath" class="block text-gray-700 font-bold mb-2">DrivePath File:</label>
        <input type="text" class="border border-gray-300 rounded-lg p-2 w-full" id="DrivePath" name="DrivePath" placeholder="Enter or view the drive path">
        <a class="kpdf text-blue-500 hover:underline mt-2 block" href="#" target="_blank" id="driveLink">View DrivePath File</a>
      </div>
      <div class="form-group mt-4">
        <button type="submit" class="w-full bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="footer" class="mt-6"></div>

<script>
let currentPage = 1;
let totalPages = 1;
let totalRecords = 0;

// Load header & footer dynamically
$(document).ready(function(){
  $('#header').load('header.html'); 
  $('#footer').load('footer.html');
});

// Modal control
function closeModal(){
  const modal = document.getElementById('popup-modal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
}

function openRationModal(idd){
  document.getElementById('frid').value = idd;

//  const apiUrl = 'https://script.google.com/macros/s/AKfycbylU-edHXOcpyD-QgW46TK_KUilt44uCnJ8y91ZCRR5v7ufL8ExseSFCo86LBfjKqRN_g/exec';
const apiUrl='https://script.google.com/macros/s/AKfycbzr70Htu24vHJp_-76csz_77ePKIPUBTAor5qmhKK4PZGC6KPLI3x1iv2PeVYIQtAr5mw/exec';
  fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: 'idd=' + encodeURIComponent(idd)
  })
  .then(res => res.json())
  .then(data => {
      document.getElementById('dration_no').value = data.ration || '';
      document.getElementById('mukhiya').value = data.mukhiya || '';
      document.getElementById('DrivePath').value = data.pdf_path || '';
      document.getElementById('Janpad').value = data.janpad || '';

      const linkEl = document.getElementById('driveLink');
      if(data.pdf_path){
        linkEl.href = data.pdf_path;
        linkEl.classList.remove('hidden');
      } else {
        linkEl.removeAttribute('href');
        linkEl.classList.add('hidden');
      }

      const modal = document.getElementById('popup-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
  })
  .catch(err => console.error('Fetch Error:', err));
}

// Load first row modal on page load
function openFirstRowModal(){
  fetch('https://script.google.com/macros/s/AKfycbzbA6qZsYHSHAMEZ09dRQ3laXtp-ts1FcpdePa5HARqbV7UMfQb2s4SpEV4b-qMio_A/exec')
  .then(res => res.json())
  .then(data => {
    if(data && data.length > 0){
      const firstId = data[0].id;
      openRationModal(firstId);
    }
  })
  .catch(err => console.error(err));
}

// Table data load
function loadData(page) {
  const search = document.getElementById('searchInput').value;
  const role = localStorage.getItem('role') || '';
  const userId = localStorage.getItem('id') || '';
  const contact_number = localStorage.getItem('contact_number') || 0;
  const current_balance = localStorage.getItem('current_balance') || 0;

  Swal.fire({
    title: 'Fetching Data...',
    text: 'कृपया प्रतीक्षा करें',
    allowOutsideClick: false,
    didOpen: () => { Swal.showLoading(); }
  });

  let s='https://script.google.com/macros/s/AKfycbyIpT_lUDwueKOfkFwQm5Byg1W8yZbOjMkcJyODvDlegFQdbUIAwt90dWPAM76NKiIAqA/exec';
  
  fetch(`${s}?page=${page}&search=${encodeURIComponent(search)}&role=${role}&userId=${userId}`)
    .then(res => res.json())
    .then(data => {
      Swal.close();
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      data.data.forEach((row, i) => {
        let pdfCell = row.pdf_path && row.pdf_path.trim() !== ''
            ? `<a class="text-blue-500 hover:underline" target="_blank" href="${row.pdf_path}">Download PDF</a>` 
            : ``;

            let btnCheck = '';
            if (localStorage.getItem('role') === 'admin') {
                btnCheck = `<button class="neditButton bg-green-500 text-white py-1 px-2 rounded" data-idd="${row.id}">Check Detail</button>`;
            }

        tbody.innerHTML += `
          <tr>
            <td class="px-6 py-3 font-bold">${i + 1 + (page - 1) * 10}</td>
            <td class="px-6 py-3 font-bold">${row.contact_number}<br/>Balance: ${row.current_balance}</td>
            <td class="px-6 py-3 font-bold">${row.name}</td>
            <td class="px-6 py-3 font-bold">${row.janpad}<br/>${row.edate}</td>
            <td class="px-6 py-3 font-bold">${row.ration}${btnCheck}
              
            </td>
            <td class="px-6 py-3">${pdfCell}</td>
          </tr>`;
      });

      currentPage = data.page;
      totalPages = data.totalPages;
      totalRecords = data.totalRecords;

      document.getElementById('pageInfo').innerText =
        `Page ${currentPage} of ${totalPages} — Total Records: ${totalRecords}`;
    })
    .catch(err => {
      Swal.close();
      console.error(err);
      Swal.fire({ icon: 'error', title: 'Error', text: 'Data fetch करने में समस्या हुई।' });
    });
}

function prevPage() { if (currentPage > 1) loadData(currentPage - 1); }
function nextPage() { if (currentPage < totalPages) loadData(currentPage + 1); }
function goToPage() {
  const pageInput = parseInt(document.getElementById('pageNumberInput').value, 10);
  if (!isNaN(pageInput) && pageInput >= 1 && pageInput <= totalPages) {
    loadData(pageInput);
  } else {
    alert('Please enter a valid page number between 1 and ' + totalPages);
  }
}

// Event delegation for modal buttons
document.addEventListener('click', function (e) {
  if (e.target && e.target.classList.contains('neditButton')) {
    const idd = e.target.getAttribute('data-idd');
    openRationModal(idd);
  }
});

// Form submit
$('#rationForm').submit(function(event){
  event.preventDefault();

  const formDataStr = $.param($(this).serializeArray());

  $.ajax({
    type: 'POST',
    url: 'https://script.google.com/macros/s/AKfycbzbA6qZsYHSHAMEZ09dRQ3laXtp-ts1FcpdePa5HARqbV7UMfQb2s4SpEV4b-qMio_A/exec',
    data: formDataStr,
    contentType: 'application/x-www-form-urlencoded',
    success: function(response){
      swal("Success!", "Data updated successfully", "success");
      const rid = $('#frid').val();
      openRationModal(rid); // refresh modal after save
    },
    error: function(err){
      console.error(err);
      swal("Error!", "Something went wrong", "error");
    }
  });
});

// Initial load
$(document).ready(function(){
  openFirstRowModal();
  loadData(1);
});
</script>

</body>
</html>
